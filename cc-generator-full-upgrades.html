<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Card Generator — Full Upgrades (Flip, Logos, Print, Obfuscate)</title>
<meta name="description" content="Generate & validate test credit cards, render front/back images with flip animation, high-fidelity SVG logos, print sheet generator and obfuscation toggle." />
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --muted:#6b7280; --accent:#2563eb; --accent-2:#1e3a8a;
    --ok:#059669; --bad:#dc2626; --radius:12px;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:#0b1724}
 
header{background:linear-gradient(90deg,var(--accent),#1e3a8a);color:#fff;padding:16px;border-radius:0px;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}

    header h1{margin:0;font-size:1.15rem}
    header p{margin:6px 0 0;font-size:0.9rem;opacity:0.95}
    header a button{background:#fff;color:var(--accent);border:none;padding:8px 12px;border-radius:px;cursor:pointer;font-weight:600}
    .hero-placeholder{margin:18px 0;text-align:center}
    .hero-placeholder img{width:100%;max-height:240px;object-fit:cover;border-radius:0px;box-shadow:0 8px 24px rgba(0,0,0,0.08)}

  .container{max-width:800px;margin:10px auto;padding:16px}
/*.container { max-width:700px; margin:30px auto; background:#fff; padding:25px; padding-bottom:70px;border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }*/
  .grid{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;margin-top:10px;}
  .col{flex:1;min-width:300px}
  .card{background:#fff;border-radius:12px;padding:16px;margin-top:5px;box-shadow:0 10px 32px rgba(2,6,23,0.06)}
  label{display:block;margin-top:8px;font-weight:600}
  input,select,button,textarea{font:inherit}
  input[type="text"],select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef7}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{background:var(--accent);color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  button.ghost{background:#fff;color:var(--accent);border:1px solid #e6eef7}
  .muted{color:var(--muted);font-size:0.95rem}
  .result{margin-top:12px;padding:10px;border-radius:8px;font-weight:700;text-align:center}
  .result.ok{background:#ecfdf5;color:var(--ok)}
  .result.bad{background:#fff5f5;color:var(--bad)}
  pre{background:#f1f5f9;padding:10px;border-radius:8px;overflow:auto}
  footer{margin-top:18px;text-align:center;color:var(--muted)}
  /*@media (max-width:980px){ .grid{flex-direction:column} }*/

  /* card preview + enhanced flip */
  .preview-wrap{display:flex;flex-direction:column;align-items:center;gap:10px}
  .card-frame { perspective: 2000px; width:100%; display:flex;justify-content:center;align-items:center }
  .card-inner { width:560px; max-width:100%; height:350px; position:relative; transform-style:preserve-3d; transition: transform 700ms cubic-bezier(.2,.8,.2,1); }
  .card-inner.flipped { transform: rotateY(180deg); }
  .card-face { position:absolute; inset:0; backface-visibility:hidden; border-radius:16px; display:flex;align-items:center;justify-content:center; overflow:hidden; }
  .card-face.back { transform: rotateY(180deg); }
  .card-canvas{display:block;width:100%;height:100%;border-radius:16px;box-shadow:0 14px 36px rgba(2,6,23,0.18)}
  /* reflection/blur overlay during flip */
  .flip-reflection {
    position:absolute; left:0; right:0; top:0; bottom:0; pointer-events:none; border-radius:16px;
    background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0)); mix-blend-mode:overlay;
    opacity:0; transition:opacity 300ms ease;
  }
  .card-inner.flipped + .flip-reflection { opacity:1; filter: blur(8px); transform: translateZ(-20px); }

  /* print sheet modal style (simple) */
  .print-actions{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
  .small{font-size:0.9rem;color:var(--muted)}
  .checkbox{display:inline-flex;align-items:center;gap:8px}

.h3-style{font-size:15px;}

</style>
</head>
<body>
  <header>
    <h1>Credit Card Number Generator</h1>
    <a href="index.html"><button>Home</button></a>
  </header>
  <!-- Hero -->
  <section class="hero-placeholder">
    <img src="images/webtools-hero-image4.png" alt="Hero image placeholder">
  </section>
<div class="container">
  <div class="grid" style="margin-top:10px">
    <!-- Controls -->
    <div class="col card">
      <div class="muted">Generate Credit card Number, Flip animation, hi-fi logos, print sheet generator, obfuscation toggle. For sandbox/testing only.</div>
      <h3 class="h3-style">CARD CONTROLS</h3>

      <label class="small">Network</label>
      <select id="networkSelect"></select>
      <div class="row">
        <button  id="generateBtn">Generate Card</button>
      </div>

      <label class="small">Card Number</label>
      <input id="cardNumber" type="text" inputmode="numeric" placeholder="4111111111111111">

      <label class="small">Cardholder Name</label>
      <input id="cardHolder" type="text" placeholder="JOHN DOE">

      <div class="row">
        <div style="flex:1">
          <label class="small">Expiry Month</label>
          <select id="expMonth"></select>
        </div>
        <div style="flex:1">
          <label class="small">Expiry Year</label>
          <select id="expYear"></select>
        </div>
        <div style="flex:0 0 110px">
          <label class="small">CVV</label>
          <input id="cvv" maxlength="4" type="text" placeholder="123">
        </div>
        <button id="validateBtn" class="ghost">Validate Number (Luhn)</button>
        <button id="serverValidateBtn" class="ghost">Validate via Server API</button>
        <p class="small">Note: Select Network first and then Use "Generate Card" button to auto generate card number, expiry month, expiry year & CVV. You can change card holder name."</p>
      </div>
      <div id="luhnResult" class="result" style="display:none"></div>
    </div>
 </div>

    <!-- Preview -->
    <div class="col card">
      <h3 class="h3-style">CARD PREVIEW, PRINT & DOWNLOAD</h3>
       <label class="small">Template</label>
      <div class="row">
        <select id="templateSelect">
          <option value="classic">Classic</option>
          <option value="metal">Metal</option>
          <option value="glass">Glass</option>
          <option value="vintage">Vintage</option>
        </select>
        
        <label class="small">Size</label>
        <select id="sizeSelect">
          <option value="medium" selected>Medium</option>
          <option value="small">Small</option>
          <option value="large">Large</option>
        </select>

        <div style="flex:1"></div>
        <label class="checkbox small"><input id="obfuscateToggle" type="checkbox"/> Obfuscate digits (show last 4)</label>
      </div>

      <div class="row" style="align-items:center">
        <button id="showFrontBtn" class="ghost">Front</button>
        <button id="showBackBtn" class="ghost">Back</button>
        
        <div style="flex:1"></div>
      </div>

      <div class="preview-wrap" style="margin-top:12px">
        <div class="card-frame">
          <div id="cardInner" class="card-inner">
            <div id="faceFront" class="card-face front"></div>
            <div id="faceBack" class="card-face back"></div>
          </div>
        </div>
        <div class="flip-reflection" id="flipReflection" aria-hidden="true"></div>
      </div>

      <div id="cardActions"></div>
      <div class="muted" style="margin-top:8px">Use the "Generate Card" button to render a card. Toggle obfuscation to hide digits when saving or printing.</div>
        <button style="float:right; margin-right:100px; margin-top:10px;"id="downloadCardBtn">Download PNG</button>
	<hr style="margin-top:60px;">
	<h4>Print Sheet</h4>
      <div class="row">
        <label class="small" style="flex:1">Copies per page</label>
        <select id="copiesPerPage" style="width:120px">
          <option value="1">1</option><option value="2">2</option><option value="4" selected>4</option>
        </select>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="checkbox small"><input id="includeBack" type="checkbox" checked/> Include backs</label>
        <label style="flex:1"></label>
      </div>

      <div style="margin-top:10px" class="print-actions">
        <button id="generatePrintBtn">Generate A4 Print Sheet</button>
        <button id="openPrintPreviewBtn" class="ghost">Open Print Preview</button>
      </div>
    </div>
  
  <!-- Payload restored -->
  <div class="card" style="margin-top:18px">
    <h3 class="h3-style">SANDBOX PAYMENT PAYLOAD</h3>
    <div class="row">
      <div style="flex:1">
        <label class="small">Amount</label>
        <input style="padding:10px;border-radius:6px;border:1px solid grey;" id="amount" type="number" value="49.99" step="0.01">
      </div>
      <div style="flex:1">
        <label class="small">Currency</label>
        <select id="currency">
          <option>USD</option><option>EUR</option><option>GBP</option><option>AUD</option><option>INR</option>
        </select>
      </div>
      <div style="flex:1">
        <label class="small">Merchant / Order ID</label>
        <input style="padding:10px;border-radius:6px;border:1px solid grey;" id="orderId" placeholder="ORDER-1234">
      </div>
    </div>
    <div style="margin-top:10px">
      <button id="generatePayload">Generate Payload</button>
      <pre id="payloadArea" style="margin-top:10px;background:#fafbff;padding:10px;border-radius:8px;border:1px solid #eef6ff;"></pre>
    </div>
  </div>
  
  <div class="card">
  <h2 class="small">🐍 Python Server Example (FastAPI)</h2>
  <pre><code>
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

class Card(BaseModel):
    number: str

def luhn_valid(num: str) -> bool:
    digits = [int(d) for d in num if d.isdigit()]
    total, double = 0, False
    for d in reversed(digits):
        if double:
            d = d * 2 - 9 if d * 2 > 9 else d * 2
        total += d
        double = not double
    return total % 10 == 0

@app.post("/validate_card")
def validate_card(card: Card):
    return {"card_number": card.number, "valid": luhn_valid(card.number)}
  </code></pre>
</div>

<div class="card">
  <h2 class="small">🟢 Node.js Server Example (Express)</h2>
  <pre><code>
// server.js
import express from "express";
import bodyParser from "body-parser";
const app = express();
app.use(bodyParser.json());
function luhnValid(num) {
  const digits = (num || "").replace(/\D/g, "").split("").map(Number);
  let total = 0, double = false;
  for (let i = digits.length - 1; i >= 0; i--) {
    let d = digits[i];
    if (double) { d = d * 2; if (d > 9) d -= 9; }
    total += d; double = !double;
  }
  return total % 10 === 0;
}
app.post("/validate_card", (req,res)=>{
  const { number } = req.body;
  if(!number) return res.status(400).json({error:"Missing number"});
  res.json({card_number:number, valid:luhnValid(number)});
});
app.listen(3000,()=>console.log("✅ Server running on http://localhost:3000"));
  </code></pre>
</div>
</div>
  <footer style="margin-top:18px;text-align:center;color:var(--muted);background:black;padding:16px;"> ©<span id="year">2025</span>: Web ToolBox [For sandbox use]</footer>
<script>
/* -------------------------
   Data and helpers
   ------------------------- */
document.getElementById('year').textContent = new Date().getFullYear();

/* High-fidelity SVG logos (inline strings) */
const LOGOS_SVG = {
  Visa: `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 48'><defs><linearGradient id='v' x1='0' x2='1'><stop offset='0' stop-color='#1a1f71'/><stop offset='1' stop-color='#3b82f6'/></linearGradient></defs><rect width='160' height='48' rx='6' fill='none'/><text x='10' y='34' font-family='Verdana' font-weight='800' font-size='28' fill='white'>VISA</text></svg>`,
  Mastercard: `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 48'><circle cx='62' cy='24' r='16' fill='#ff5f00'/><circle cx='88' cy='24' r='16' fill='#eb001b' opacity='0.95'/></svg>`,
  Amex: `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 170 48'><text x='8' y='32' font-family='Verdana' font-weight='800' font-size='18' fill='white'>AMERICAN EXPRESS</text></svg>`,
  Discover: `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 48'><text x='8' y='32' font-family='Verdana' font-weight='700' font-size='20' fill='white'>DISCOVER</text></svg>`,
  JCB: `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 48'><rect x='6' y='6' width='148' height='36' rx='6' fill='none'/><text x='10' y='32' font-family='Verdana' font-weight='700' font-size='18' fill='white'>JCB</text></svg>`,
  'Diners Club': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 170 48'><circle cx='28' cy='24' r='12' fill='white' opacity='0.12'/><text x='52' y='32' font-family='Verdana' font-weight='700' font-size='18' fill='white'>DINERS CLUB</text></svg>`,
  Maestro: `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 48'><circle cx='56' cy='24' r='14' fill='#ff5f00'/><circle cx='86' cy='24' r='14' fill='#0f1724' opacity='0.95'/></svg>`,
  'Visa Electron': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 48'><text x='8' y='30' font-family='Verdana' font-weight='700' font-size='16' fill='white'>VISA ELECTRON</text></svg>`,
  InstaPayment: `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 48'><text x='8' y='32' font-family='Verdana' font-weight='700' font-size='16' fill='white'>INSTA</text></svg>`
};

function svgToDataUrl(svg){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg); }

/* Network configuration: ranges and color presets for templates */
const NETWORKS = {
  "Visa": { prefixes:["4"], colors:[["#1a1f71","#3b82f6"],["#0b63d8","#60a5fa"]] },
  "Mastercard": { prefixes:["51","52","53","54","55","2221-2720"], colors:[["#ff5f00","#eb001b"],["#ff8a00","#d90429"]] },
  "Amex": { prefixes:["34","37"], colors:[["#1072b7","#21a1f1"],["#0b63d8","#60a5fa"]] },
  "Discover": { prefixes:["6011","65"], colors:[["#f58220","#f7ad65"],["#f97316","#fb923c"]] },
  "JCB": { prefixes:["3528-3589"], colors:[["#007b5f","#00b894"],["#0f766e","#34d399"]] },
  "Diners Club": { prefixes:["300","301","305","36","38"], colors:[["#0061a8","#60a5fa"],["#0f1724","#1e293b"]] },
  "Maestro": { prefixes:["50","56","57","58","59","60","62","67"], colors:[["#0f1724","#334155"],["#111827","#374151"]] },
  "Visa Electron": { prefixes:["4026","417500","4508","4844","4913","4917"], colors:[["#0b63d8","#60a5fa"],["#1e40af","#60a5fa"]] },
  "InstaPayment": { prefixes:["637","638","639"], colors:[["#6b21a8","#a78bfa"],["#7c3aed","#c4b5fd"]] }
};

/* Basic utilities */
function sanitizeNumber(s){ return String(s||'').replace(/\D/g,''); }
function randDigits(n){ let s=''; for(let i=0;i<n;i++) s += Math.floor(Math.random()*10); return s; }
function computeLuhnCheckDigit(partial){
  const digits = sanitizeNumber(partial).split('').map(d=>parseInt(d,10));
  digits.push(0);
  let sum=0, double=false;
  for(let i=digits.length-1;i>=0;i--){
    let d = digits[i];
    if(double){ d = d*2; if(d>9) d -= 9; }
    sum += d; double = !double;
  }
  return (10 - (sum % 10)) % 10;
}
function generateCardNumber(prefix, length=16){
  const p = String(prefix).replace(/\D/g,'');
  const needed = Math.max(0, length - p.length - 1);
  let body = p;
  for(let i=0;i<needed;i++) body += Math.floor(Math.random()*10);
  const check = computeLuhnCheckDigit(body);
  return body + String(check);
}

/* DOM refs */
const networkSelect = document.getElementById('networkSelect');
const generateBtn = document.getElementById('generateBtn');
const validateBtn = document.getElementById('validateBtn');
const serverValidateBtn = document.getElementById('serverValidateBtn');
const cardNumberInput = document.getElementById('cardNumber');
const cardHolderInput = document.getElementById('cardHolder');
const expMonth = document.getElementById('expMonth');
const expYear = document.getElementById('expYear');
const cvvInput = document.getElementById('cvv');
const luhnResult = document.getElementById('luhnResult');
const cardInner = document.getElementById('cardInner');
const faceFront = document.getElementById('faceFront');
const faceBack = document.getElementById('faceBack');
const showFrontBtn = document.getElementById('showFrontBtn');
const showBackBtn = document.getElementById('showBackBtn');
const downloadCardBtn = document.getElementById('downloadCardBtn');
const templateSelect = document.getElementById('templateSelect');
const sizeSelect = document.getElementById('sizeSelect');
const obfuscateToggle = document.getElementById('obfuscateToggle');

const copiesPerPage = document.getElementById('copiesPerPage');
const includeBack = document.getElementById('includeBack');
const generatePrintBtn = document.getElementById('generatePrintBtn');
const openPrintPreviewBtn = document.getElementById('openPrintPreviewBtn');

const amountInput = document.getElementById('amount');
const currencySelect = document.getElementById('currency');
const orderInput = document.getElementById('orderId');
const generatePayloadBtn = document.getElementById('generatePayload');
const payloadArea = document.getElementById('payloadArea');

Object.keys(NETWORKS).forEach(n => {
  const o = document.createElement('option'); o.value = n; o.textContent = n; networkSelect.appendChild(o);
});
networkSelect.value = 'Visa';

/* expiry selects */
for(let m=1;m<=12;m++){ const o=document.createElement('option'); o.value=String(m).padStart(2,'0'); o.textContent=o.value; expMonth.appendChild(o); }
const now = new Date().getFullYear();
for(let y=now;y<=now+12;y++){ const o=document.createElement('option'); o.value=String(y); o.textContent=o.value; expYear.appendChild(o); }

/* canvas drawing helpers (front/back), with obfuscation */
function sizeToPixels(sizeKey){
  if(sizeKey === 'small') return {w:400,h:240};
  if(sizeKey === 'large') return {w:900,h:570};
  return {w:560,h:350}; // medium default
}

function templateStyle(network, templateKey){
  const base = NETWORKS[network] ? NETWORKS[network].colors[0] : ['#374151','#111827'];
  if(templateKey === 'classic') return {grad: base, gloss:0.18, metal:false};
  if(templateKey === 'metal') return {grad: NETWORKS[network].colors[1] || base, gloss:0.06, metal:true};
  if(templateKey === 'glass') return {grad: ['rgba(255,255,255,0.06)','rgba(255,255,255,0.02)'], gloss:0.36, metal:false};
  if(templateKey === 'vintage') return {grad:['#b08b4f','#6b4c2a'], gloss:0.06, metal:false};
  return {grad: base, gloss:0.18, metal:false};
}

/* draw front */
function drawFront({network, number, name, expMonth, expYear, cvv, template, sizeKey, obfuscate}){
  const {w,h} = sizeToPixels(sizeKey);
  const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');

  function roundRect(x,y,wid,hei,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+wid,y,x+wid,y+hei,r); ctx.arcTo(x+wid,y+hei,x,y+hei,r); ctx.arcTo(x,y+hei,x,y,r); ctx.arcTo(x,y,x+wid,y,r); ctx.closePath(); }

  const style = templateStyle(network, template);
  const grad = ctx.createLinearGradient(0,0,w,h);
  grad.addColorStop(0, style.grad[0]); grad.addColorStop(1, style.grad[1] || style.grad[0]);
  roundRect(8,8,w-16,h-16,18); ctx.fillStyle = grad; ctx.fill();

  // subtle pattern
  ctx.globalAlpha = template === 'glass' ? 0.02 : 0.06;
  ctx.fillStyle = '#ffffff';
  for(let i=-w;i<w*2;i+=36){ ctx.fillRect(i,0,18,h); }
  ctx.globalAlpha = 1;

  // gloss
  const gloss = ctx.createLinearGradient(0,0,w,h/2);
  gloss.addColorStop(0, `rgba(255,255,255,${style.gloss})`);
  gloss.addColorStop(0.4, `rgba(255,255,255,${style.gloss/3})`);
  gloss.addColorStop(1, 'rgba(255,255,255,0)');
  ctx.globalCompositeOperation = style.metal ? 'overlay' : 'soft-light';
  roundRect(8,8,w-16,h-16,18); ctx.fillStyle = gloss; ctx.fill();
  ctx.globalCompositeOperation = 'source-over';

  // chip
  roundRect(48, h*0.28, 72, 50, 6); ctx.fillStyle = '#d1d5db'; ctx.fill();
  roundRect(52, h*0.28+4, 64, 42, 5); ctx.fillStyle = '#cbd5e1'; ctx.fill();

  // number (obfuscate if needed)
  ctx.textAlign = 'left';
  ctx.fillStyle = 'white';
  ctx.font = `${Math.round(w/26)}px monospace`;
  let dispNumber = number || '#### #### #### ####';
  if(obfuscate && dispNumber.length >= 4){
    const last4 = dispNumber.slice(-4);
    dispNumber = '●●●● ●●●● ●●●● ' + last4;
  } else {
    // group into 4s
    dispNumber = (dispNumber || '').replace(/(.{4})/g,"$1 ").trim();
  }
  ctx.fillText(dispNumber, 48, h*0.56);

  // expiry
  ctx.font = `${Math.round(w/42)}px Arial`;
  ctx.fillStyle = 'rgba(255,255,255,0.9)';
  ctx.fillText('VALID THRU', 48, h*0.68);
  ctx.font = `${Math.round(w/34)}px Arial`;
  ctx.fillText((expMonth||'MM') + '/' + (String(expYear||'YY').slice(-2)), 140, h*0.68);

  // name
  ctx.font = `${Math.round(w/28)}px Arial`;
  ctx.fillStyle = 'rgba(255,255,255,0.95)';
  ctx.fillText((name||'CARDHOLDER').toUpperCase(), 48, h*0.78);

  // logo
  const logoSvg = LOGOS_SVG[network] || LOGOS_SVG['Visa'];
  const img = new Image();
  img.src = svgToDataUrl(logoSvg);
  img.onload = () => {
    const lw = Math.round(w*0.22), lh = Math.round(h*0.14);
    ctx.drawImage(img, w - 20 - lw, 20, lw, lh);
  };

  // soft inner shadow
  ctx.globalCompositeOperation = 'multiply';
  const shadowGrad = ctx.createLinearGradient(0,0,0,h);
  shadowGrad.addColorStop(0, 'rgba(0,0,0,0.02)'); shadowGrad.addColorStop(1, 'rgba(0,0,0,0.12)');
  roundRect(8,8,w-16,h-16,18); ctx.fillStyle = shadowGrad; ctx.fill();
  ctx.globalCompositeOperation = 'source-over';
  return canvas;
}

/* draw back */
function drawBack({network, number, name, expMonth, expYear, cvv, template, sizeKey, obfuscate}){
  const {w,h} = sizeToPixels(sizeKey);
  const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx = canvas.getContext('2d');
  function roundRect(x,y,wid,hei,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+wid,y,x+wid,y+hei,r); ctx.arcTo(x+wid,y+hei,x,y+hei,r); ctx.arcTo(x,y+hei,x,y,r); ctx.arcTo(x,y,x+wid,y,r); ctx.closePath(); }

  const style = templateStyle(network, template);
  const grad = ctx.createLinearGradient(0,0,w,h);
  grad.addColorStop(0, style.grad[0]); grad.addColorStop(1, style.grad[1] || style.grad[0]);
  roundRect(8,8,w-16,h-16,18); ctx.fillStyle = grad; ctx.fill();

  // magnetic stripe
  ctx.fillStyle = 'rgba(0,0,0,0.88)'; ctx.fillRect(8, 32, w-16, Math.round(h*0.14));

  // white signature box area
  ctx.fillStyle = '#fff'; roundRect(36, Math.round(h*0.34), w-72, Math.round(h*0.18), 4); ctx.fill();

  // CVV box on right
  const cvvW = Math.round(w*0.22), cvvH = Math.round(h*0.1);
  ctx.fillStyle = '#f3f4f6'; ctx.fillRect(w - 36 - cvvW, Math.round(h*0.38), cvvW, cvvH);
  ctx.fillStyle = '#111827'; ctx.font = `${Math.round(w/34)}px monospace`;
  const dispCvv = obfuscate ? '***' : (cvv || '***');
  ctx.fillText(dispCvv, w - 36 - cvvW + 12, Math.round(h*0.38) + Math.round(cvvH*0.65));

  // small printed number below
  ctx.fillStyle = 'rgba(255,255,255,0.92)'; ctx.font = `${Math.round(w/48)}px Arial`;
  let dispNumber = number || '#### #### #### ####';
  if(obfuscate && dispNumber.length >= 4){
    const last4 = dispNumber.slice(-4);
    dispNumber = '●●●● ●●●● ●●●● ' + last4;
  } else {
    dispNumber = (dispNumber || '').replace(/(.{4})/g,"$1 ").trim();
  }
  ctx.fillText('Card: ' + dispNumber, 36, Math.round(h*0.68));

  const svg = LOGOS_SVG[network] || LOGOS_SVG['Visa'];
  const img = new Image();
  img.src = svgToDataUrl(svg);
  img.onload = () => {
    const lw = Math.round(w*0.18), lh = Math.round(h*0.11);
    ctx.drawImage(img, w - 20 - lw, h - 36 - lh, lw, lh);
  };

  return canvas;
}

/* render preview to faces and manage flip */
let lastFrontCanvas = null, lastBackCanvas = null;
function renderPreview(side='front'){
  const network = networkSelect.value;
  const number = sanitizeNumber(cardNumberInput.value) || generateCardNumber(NETWORKS[network].prefixes[0], network==='Amex'?15:16);
  const name = cardHolderInput.value || 'JOHN DOE';
  const month = expMonth.value || '01';
  const year = expYear.value || String(now+3);
  const cvv = cvvInput.value || (network==='Amex'? String(Math.floor(1000+Math.random()*9000)) : String(Math.floor(100+Math.random()*900)));
  const template = templateSelect.value || 'classic';
  const sizeKey = sizeSelect.value || 'medium';
  const obfuscate = obfuscateToggle.checked;

  lastFrontCanvas = drawFront({network, number, name, expMonth:month, expYear:year, cvv, template, sizeKey, obfuscate});
  lastBackCanvas = drawBack({network, number, name, expMonth:month, expYear:year, cvv, template, sizeKey, obfuscate});

  faceFront.innerHTML = ''; faceBack.innerHTML = '';
  lastFrontCanvas.className = 'card-canvas'; lastBackCanvas.className = 'card-canvas';
  faceFront.appendChild(lastFrontCanvas); faceBack.appendChild(lastBackCanvas);

  if(side === 'front') cardInner.classList.remove('flipped'); else cardInner.classList.add('flipped');
}

/* UI wiring */
generateBtn.addEventListener('click', ()=>{
  const net = networkSelect.value;
  // random prefix expansion if range
  let prefixSpec = NETWORKS[net].prefixes[Math.floor(Math.random()*NETWORKS[net].prefixes.length)];
  let prefix = prefixSpec;
  if(prefixSpec.includes('-')){
    const [a,b] = prefixSpec.split('-').map(s=>s.trim());
    const an=parseInt(a,10), bn=parseInt(b,10);
    prefix = String(Math.floor(Math.random()*(bn-an+1))+an);
  }
  const length = net==='Amex'?15:16;
  const num = generateCardNumber(prefix, length);
  cardNumberInput.value = num;
  cardHolderInput.value = 'JOHN DOE';
  cvvInput.value = net==='Amex'? String(Math.floor(1000+Math.random()*9000)) : String(Math.floor(100+Math.random()*900));
  expMonth.selectedIndex = Math.floor(Math.random()*12);
  expYear.selectedIndex = Math.floor(Math.random()*6);
  renderPreview('front');
  luhnResult.style.display = 'none';
});

validateBtn.addEventListener('click', ()=>{
  const num = sanitizeNumber(cardNumberInput.value);
  if(!num){ alert('Enter or generate a card number'); return; }
  const digits = num.split('').reverse().map(d=>parseInt(d,10));
  let sum=0;
  for(let i=0;i<digits.length;i++){ let d=digits[i]; if(i%2===1){ d*=2; if(d>9) d-=9; } sum+=d; }
  const valid = sum%10===0;
  luhnResult.style.display = 'block';
  luhnResult.className = valid ? 'result ok' : 'result bad';
  luhnResult.textContent = valid ? '✔ Luhn VALID' : '✖ Luhn INVALID';
});

serverValidateBtn.addEventListener('click', async ()=>{
  const number = cardNumberInput.value.trim();
  if(!number){ alert('Enter or generate a card number'); return; }
  try{
    const res = await fetch('http://localhost:3000/validate_card', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ number })});
    const data = await res.json();
    luhnResult.style.display = 'block';
    luhnResult.className = data.valid ? 'result ok' : 'result bad';
    luhnResult.textContent = 'Server Validation: ' + (data.message || (data.valid ? 'Luhn VALID' : 'Luhn INVALID'));
  }catch(e){
    luhnResult.style.display = 'block';
    luhnResult.className = 'result bad';
    luhnResult.textContent = '❌ Could not connect to server. Is it running?';
    console.error(e);
  }
});

/* flip buttons */
showFrontBtn.addEventListener('click', ()=>{ cardInner.classList.remove('flipped'); setTimeout(()=> renderPreview('front'), 360); });
showBackBtn.addEventListener('click', ()=>{ cardInner.classList.add('flipped'); setTimeout(()=> renderPreview('back'), 360); });

/* template/size/obfuscate change -> rerender */
templateSelect.addEventListener('change', ()=> renderPreview(cardInner.classList.contains('flipped')?'back':'front'));
sizeSelect.addEventListener('change', ()=> renderPreview(cardInner.classList.contains('flipped')?'back':'front'));
obfuscateToggle.addEventListener('change', ()=> renderPreview(cardInner.classList.contains('flipped')?'back':'front'));

/* download current visible side canvas */
downloadCardBtn.addEventListener('click', ()=>{
  const isBack = cardInner.classList.contains('flipped');
  const canvas = isBack ? faceBack.querySelector('canvas') : faceFront.querySelector('canvas');
  if(!canvas){ alert('No card generated yet. Click Generate Card first.'); return; }
  const link = document.createElement('a');
  link.href = canvas.toDataURL('image/png');
  link.download = 'fake_card_' + Date.now() + '.png';
  link.click();
});

/* payload generator */
generatePayloadBtn.addEventListener('click', ()=>{
  const payload = {
    card_number: cardNumberInput.value,
    cardholder_name: cardHolderInput.value,
    expiry_month: expMonth.value,
    expiry_year: expYear.value,
    cvv: cvvInput.value,
    amount: parseFloat(amountInput.value || 0),
    currency: currencySelect.value,
    order_id: orderInput.value || ('ORD-' + Date.now())
  };
  payloadArea.textContent = JSON.stringify(payload, null, 2);
});

/* Print sheet generator */
/* We'll generate an A4 canvas (2480x3508 px at 300dpi is heavy). To keep performance reasonable,
   produce medium-resolution A4 (1748x2480 ~ 150dpi) by default and scale option if needed. */

function generateA4Sheet({copies=4, includeBacks=true, sizeKey='medium', obfuscate=false, template}) {
  // A4 portrait in px for moderate resolution
  const pageW = 1748; // ~150dpi width 8.27in *150
  const pageH = 2480;
  const canvas = document.createElement('canvas');
  canvas.width = pageW; canvas.height = pageH;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,pageW,pageH);

  // layout settings (margins + gaps)
  const marginX = 40, marginY = 60;
  const gapX = 24, gapY = 40;

  // determine columns (keep original intent: 4->2 cols, 2->1 col, 1->1 col)
  const cols = (copies === 4) ? 2 : (copies === 2 ? 1 : 1);
  const rows = Math.ceil(copies / cols);

  // calculate card width accounting for margins and gaps so columns never overflow
  const availableW = pageW - marginX * 2 - gapX * (cols - 1);
  const cardW = Math.floor(availableW / cols);
  const cardH = Math.floor(cardW * (350/560)); // keep approx aspect ratio

  // build positions
  const positions = [];
  let idx = 0;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(idx >= copies) break;
      const x = marginX + c * (cardW + gapX);
      const y = marginY + r * (cardH + gapY);
      positions.push({x,y,w:cardW,h:cardH});
      idx++;
    }
  }

  // draw each front and optionally back beneath/after; using safe placement to avoid width overflow
  for(let i=0;i<positions.length;i++){
    const pos = positions[i];
    // produce a small card canvas (scaled)
    const network = networkSelect.value;
    const number = sanitizeNumber(cardNumberInput.value) || generateCardNumber(NETWORKS[network].prefixes[0], network==='Amex'?15:16);
    const name = cardHolderInput.value || 'JOHN DOE';
    const month = expMonth.value || '01';
    const year = expYear.value || String(now+3);
    const cvv = cvvInput.value || '***';
    // create front/back with size approximating pos.w x pos.h
    const tmpFront = drawFront({network, number, name, expMonth:month, expYear:year, cvv, template, sizeKey:'medium', obfuscate});
    // scale tmpFront into pos
    ctx.drawImage(tmpFront, 0,0, tmpFront.width, tmpFront.height, pos.x, pos.y, pos.w, pos.h);

    if(includeBacks){
      const tmpBack = drawBack({network, number, name, expMonth:month, expYear:year, cvv, template, sizeKey:'medium', obfuscate});
      // Prefer placing back below the front to avoid increasing total width
      const belowY = pos.y + pos.h + gapY;
      if(belowY + pos.h <= pageH - marginY){
        ctx.drawImage(tmpBack, 0,0, tmpBack.width, tmpBack.height, pos.x, belowY, pos.w, pos.h);
      } else {
        // If not enough vertical space, attempt to place to the right if it fits
        const backPosX = pos.x + pos.w + gapX;
        if(backPosX + pos.w <= pageW - marginX){
          ctx.drawImage(tmpBack, 0,0, tmpBack.width, tmpBack.height, backPosX, pos.y, pos.w, pos.h);
        } else {
          // Fallback: scale the back to fit in remaining vertical space and draw below
          const maxBelowH = pageH - marginY - (pos.y + pos.h + gapY);
          const scale = Math.max(0.5, maxBelowH / pos.h);
          const drawH = Math.floor(pos.h * scale);
          const drawW = Math.floor(pos.w * scale);
          const drawY = pos.y + pos.h + gapY;
          ctx.drawImage(tmpBack, 0,0, tmpBack.width, tmpBack.height, pos.x, drawY, drawW, drawH);
        }
      }
    }
  }

  return canvas;
}

/* Action buttons for print */
generatePrintBtn.addEventListener('click', ()=>{
  const copies = parseInt(copiesPerPage.value || '4',10);
  const incBack = includeBack.checked;
  const obfuscate = obfuscateToggle.checked;
  const template = templateSelect.value;
  const sheetCanvas = generateA4Sheet({copies, includeBacks:incBack, sizeKey:'medium', obfuscate, template});
  // Download PNG
  const link = document.createElement('a');
  link.href = sheetCanvas.toDataURL('image/png');
  link.download = 'cards_print_sheet_' + Date.now() + '.png';
  link.click();
});

openPrintPreviewBtn.addEventListener('click', ()=>{
  const copies = parseInt(copiesPerPage.value || '4',10);
  const incBack = includeBack.checked;
  const obfuscate = obfuscateToggle.checked;
  const template = templateSelect.value;
  const sheetCanvas = generateA4Sheet({copies, includeBacks:incBack, sizeKey:'medium', obfuscate, template});
  // open in new tab for print preview
  const dataUrl = sheetCanvas.toDataURL('image/png');
  const w = window.open('', '_blank');
  if(!w){ alert('Popup blocked — allow popups and retry'); return; }
  w.document.write(`
  <html>
  <head>
    <title>Print Cards</title>
    <style>
      body { margin:0; padding:20px; display:flex; justify-content:center; align-items:center; background:#f9f9f9; }
      .preview-wrap { max-width:100%; width:100%; display:flex; justify-content:center; }
      img { max-width:100%; height:auto; display:block; box-shadow:0 0 10px rgba(0,0,0,0.15); }
      @media print {
        body { background:white; margin:0; padding:0; }
        img { width:210mm; height:auto; box-shadow:none; }
      }
    </style>
  </head>
  <body>
    <div class="preview-wrap"><img src="${dataUrl}" alt="Print Sheet Preview"></div>
  </body>
  </html>
  `);
  w.document.close();
});

/* initial render */
renderPreview('front');

</script>
</body>
</html>
